<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --sky: #a8d8ea; --sky-light: #d6eef8; --sky-pale: #eef7fc;
    --brown: #8b6f5e; --brown-light: #c4a882; --brown-pale: #f5ede6;
    --cream: #fdf8f3; --blush: #f2c4b8; --mint: #b8dfd0;
    --lavender: #d4c5e8; --yellow: #fce8a2;
    --pool-accent: #c4a882; --pool-soft: rgba(196,168,130,0.12);
    --text: #4a3728; --text-muted: #9e7c6a; --text-light: #c4a882;
    --white: #ffffff; --border: rgba(139,111,94,0.15);
    --border-today: rgba(168,216,234,0.6); --shadow: rgba(139,111,94,0.10);
    --drag-highlight: rgba(168,216,234,0.20); --radius: 14px;
    --top3: #c47ec0;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Zen Maru Gothic', sans-serif; background: var(--sky-pale); min-height: 100vh; padding: 20px 16px 36px; color: var(--text); -webkit-font-smoothing: antialiased; }
  .widget { max-width: 980px; margin: 0 auto; }

  /* Header */
  .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; padding: 0 2px; }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-title { font-family: 'DM Serif Display', serif; font-size: 18px; color: var(--brown); letter-spacing: -0.01em; }
  .header-deco { font-size: 10px; color: var(--brown-light); letter-spacing: 0.2em; }
  .week-label { font-size: 12px; color: var(--text-muted); font-weight: 500; }
  .nav-buttons { display: flex; align-items: center; gap: 4px; }
  .nav-btn { width: 28px; height: 28px; border: 1.5px solid var(--border); background: var(--white); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: all 0.15s ease; }
  .nav-btn:hover { background: var(--sky-pale); border-color: var(--sky); color: var(--brown); }
  .nav-btn svg { width: 14px; height: 14px; }
  .today-btn { font-size: 11px; font-weight: 700; padding: 4px 10px; border: 1.5px solid var(--border); background: var(--white); border-radius: 8px; cursor: pointer; color: var(--text-muted); font-family: 'Zen Maru Gothic', sans-serif; transition: all 0.15s ease; }
  .today-btn:hover { background: var(--sky-pale); border-color: var(--sky); color: var(--brown); }

  /* Loading */
  .loading-bar { height: 3px; background: var(--sky-light); border-radius: 99px; margin-bottom: 12px; overflow: hidden; opacity: 0; transition: opacity 0.2s; }
  .loading-bar.visible { opacity: 1; }
  .loading-bar-fill { height: 100%; background: linear-gradient(90deg, var(--sky), var(--brown-light)); border-radius: 99px; animation: loadingAnim 1.2s ease-in-out infinite; }
  @keyframes loadingAnim { 0%{width:0%;margin-left:0} 50%{width:70%;margin-left:15%} 100%{width:0%;margin-left:100%} }

  /* Grid */
  .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 8px; }

  /* Day Column */
  .day-col { background: var(--white); border: 1.5px solid var(--border); border-radius: var(--radius); overflow: hidden; display: flex; flex-direction: column; min-height: 240px; transition: border-color 0.2s, box-shadow 0.2s; box-shadow: 0 2px 10px var(--shadow); }
  .day-col:hover { border-color: var(--sky); }
  .day-col.is-today { border-color: var(--sky); box-shadow: 0 2px 14px rgba(168,216,234,0.35); background: linear-gradient(180deg, rgba(168,216,234,0.08) 0%, var(--white) 100%); }
  .day-col.is-weekend .day-header { background: rgba(242,196,184,0.12); }
  .day-col.is-holiday .day-header { background: rgba(242,196,184,0.12); }
  .day-col.drag-over { border-color: var(--sky); border-style: dashed; background: var(--drag-highlight); }

  .day-header { padding: 10px 10px 8px; text-align: center; border-bottom: 1.5px solid var(--border); background: rgba(255,255,255,0.5); position: relative; }
  .day-col.is-today .day-header { border-bottom-color: rgba(168,216,234,0.4); }
  .day-name { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; color: var(--text-light); margin-bottom: 3px; }
  .day-col.is-today .day-name { color: var(--sky); }
  .day-col.is-weekend .day-name, .day-col.is-holiday .day-name { color: var(--blush); }
  .day-number { font-family: 'DM Serif Display', serif; font-size: 22px; color: var(--text); line-height: 1; }
  .day-col.is-today .day-number { color: var(--sky); }
  .day-col.is-weekend .day-number, .day-col.is-holiday .day-number { color: #c4756a; }
  .holiday-label { font-size: 8.5px; color: #c4756a; margin-top: 2px; font-weight: 500; line-height: 1.2; }
  .day-dot { position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; border-radius: 50%; background: var(--sky); }

  /* Task List */
  .task-list { padding: 6px; flex: 1; display: flex; flex-direction: column; gap: 1px; min-height: 40px; }
  .task-item { display: flex; align-items: flex-start; gap: 5px; padding: 5px 4px; border-radius: 8px; transition: background 0.1s; cursor: default; animation: taskIn 0.2s ease; user-select: none; }
  @keyframes taskIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }
  .task-item:hover { background: var(--sky-pale); }
  .task-item.dragging { opacity: 0.3; }
  .task-item.drop-above { box-shadow: 0 -2px 0 0 var(--sky); }
  .task-item.drop-below { box-shadow: 0 2px 0 0 var(--sky); }
  .task-item.from-pool { border-left: 2px solid var(--pool-accent); padding-left: 6px; }
  .task-item.is-top3 { border-left: 2px solid var(--top3); padding-left: 6px; }

  .drag-handle { width: 8px; min-width: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-light); cursor: grab; opacity: 0; transition: opacity 0.1s; margin-top: 3px; }
  .task-item:hover .drag-handle { opacity: 0.6; }
  .drag-handle svg { width: 8px; height: 12px; }

  .task-cb { width: 14px; height: 14px; min-width: 14px; border-radius: 4px; border: 1.5px solid var(--border); background: var(--white); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; margin-top: 3px; }
  .task-cb:hover { border-color: var(--sky); background: var(--sky-pale); }
  .task-cb.checked { background: var(--sky); border-color: var(--sky); }
  .task-cb.checked svg { opacity: 1; }
  .task-cb svg { width: 9px; height: 9px; opacity: 0; color: white; transition: opacity 0.15s; }

  .task-text { font-size: 12px; line-height: 1.5; color: var(--text); flex: 1; word-break: break-word; outline: none; min-height: 18px; }
  .task-text.done { text-decoration: line-through; color: var(--text-light); }

  /* Top3 toggle button */
  .task-top3-btn { width: 16px; height: 16px; min-width: 16px; border: none; background: transparent; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.1s; color: var(--text-light); margin-top: 1px; }
  .task-item:hover .task-top3-btn { opacity: 1; }
  .task-top3-btn.active { opacity: 1 !important; color: var(--top3); }
  .task-top3-btn:hover { background: rgba(196,126,192,0.15); color: var(--top3); }
  .task-top3-btn svg { width: 10px; height: 10px; }

  .task-del { width: 16px; height: 16px; min-width: 16px; border: none; background: transparent; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.1s; color: var(--text-light); margin-top: 1px; }
  .task-item:hover .task-del { opacity: 1; }
  .task-del:hover { background: rgba(242,196,184,0.4); color: #c4756a; }
  .task-del svg { width: 10px; height: 10px; }

  .add-task-btn { display: flex; align-items: center; gap: 5px; padding: 5px 8px; border: none; background: transparent; cursor: pointer; border-radius: 8px; color: var(--text-light); font-size: 11px; font-family: 'Zen Maru Gothic', sans-serif; transition: all 0.15s; width: 100%; text-align: left; }
  .add-task-btn:hover { background: var(--sky-pale); color: var(--brown); }
  .add-task-btn svg { width: 12px; height: 12px; flex-shrink: 0; }

  /* Pool */
  .pool-col { background: var(--white); border: 1.5px solid var(--border); border-radius: var(--radius); display: flex; flex-direction: column; min-height: 240px; box-shadow: 0 2px 10px var(--shadow); transition: border-color 0.2s; }
  .pool-col.drag-over { border-color: var(--pool-accent); border-style: dashed; background: var(--pool-soft); }
  .pool-header { padding: 10px 10px 8px; border-bottom: 1.5px solid rgba(196,168,130,0.2); display: flex; align-items: center; justify-content: space-between; }
  .pool-title { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; color: var(--pool-accent); display: flex; align-items: center; gap: 4px; }
  .pool-title-icon { font-size: 11px; }
  .pool-count { font-size: 10px; font-weight: 700; padding: 1px 7px; border-radius: 99px; background: var(--brown-pale); color: var(--pool-accent); }
  .pool-list { padding: 6px; flex: 1; display: flex; flex-direction: column; gap: 1px; }
  .pool-item { display: flex; align-items: flex-start; gap: 5px; padding: 5px 4px; border-radius: 8px; border-left: 2px solid transparent; transition: all 0.1s; animation: taskIn 0.2s ease; user-select: none; cursor: default; }
  .pool-item:hover { background: var(--brown-pale); border-left-color: var(--pool-accent); }
  .pool-item.dragging { opacity: 0.3; }
  .pool-item.drop-above { box-shadow: 0 -2px 0 0 var(--pool-accent); }
  .pool-item.drop-below { box-shadow: 0 2px 0 0 var(--pool-accent); }
  .pool-handle { width: 8px; min-width: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-light); cursor: grab; opacity: 0; transition: opacity 0.1s; margin-top: 3px; }
  .pool-item:hover .pool-handle { opacity: 0.6; }
  .pool-handle svg { width: 8px; height: 12px; }
  .pool-text { font-size: 11.5px; line-height: 1.5; color: var(--text); flex: 1; word-break: break-word; outline: none; }
  .pool-del { width: 16px; height: 16px; min-width: 16px; border: none; background: transparent; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: all 0.1s; color: var(--text-light); margin-top: 1px; }
  .pool-item:hover .pool-del { opacity: 1; }
  .pool-del:hover { background: rgba(242,196,184,0.4); color: #c4756a; }
  .pool-del svg { width: 10px; height: 10px; }
  .pool-add-btn { display: flex; align-items: center; gap: 5px; padding: 5px 6px; border: none; background: transparent; cursor: pointer; border-radius: 8px; color: var(--pool-accent); font-size: 11px; font-family: 'Zen Maru Gothic', sans-serif; transition: all 0.15s; width: 100%; text-align: left; margin: 2px 0 0; }
  .pool-add-btn:hover { background: var(--brown-pale); }
  .pool-add-btn svg { width: 12px; height: 12px; flex-shrink: 0; }
  .pool-hint { padding: 6px 8px 8px; font-size: 9.5px; color: var(--text-light); text-align: center; line-height: 1.5; border-top: 1px solid rgba(196,168,130,0.15); margin-top: auto; }

  /* Footer */
  .footer { display: flex; align-items: center; gap: 12px; margin-top: 10px; padding: 0 2px; }
  .progress-bg { flex: 1; height: 6px; background: rgba(168,216,234,0.25); border-radius: 99px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--sky) 0%, var(--brown-light) 100%); border-radius: 99px; transition: width 0.4s cubic-bezier(0.4,0,0.2,1); }
  .progress-text { font-size: 10.5px; color: var(--text-muted); font-weight: 500; white-space: nowrap; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--sky-pale); border-radius: 99px; }
  ::-webkit-scrollbar-thumb { background: var(--sky); border-radius: 99px; }
  ::-webkit-scrollbar-thumb:hover { background: #8ecde5; }
  * { scrollbar-width: thin; scrollbar-color: var(--sky) var(--sky-pale); }

  /* Toast */
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--brown); color: white; font-size: 12px; font-weight: 500; padding: 8px 18px; border-radius: 99px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); opacity: 0; transition: all 0.3s ease; pointer-events: none; z-index: 9999; font-family: 'Zen Maru Gothic', sans-serif; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div class="widget">
  <div class="header">
    <div class="header-left">
      <div class="header-title">üóì Weekly Planner</div>
      <div class="header-deco">‚ú¶</div>
      <div class="week-label" id="weekLabel"></div>
    </div>
    <div class="nav-buttons">
      <button class="today-btn" onclick="goToday()">Today</button>
      <button class="nav-btn" onclick="navigate(-1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <button class="nav-btn" onclick="navigate(1)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg>
      </button>
    </div>
  </div>

  <div class="loading-bar" id="loadingBar"><div class="loading-bar-fill"></div></div>

  <div class="row" id="rowTop"></div>
  <div class="row" id="rowBottom"></div>

  <div class="footer">
    <div class="progress-bg"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ Supabase ‚îÄ‚îÄ
const SUPABASE_URL = 'https://nbduyknklcwqbinvhoih.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iZHV5a25rbGN3cWJpbnZob2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjMzNjUsImV4cCI6MjA4NzIzOTM2NX0.kzZYqBwfc8vpGszN2W3so2jURsZXlrve4KvUydYKIfA';

async function sbFetch(path, options = {}) {
  const { headers: extraHeaders, ...rest } = options;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    ...rest,
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      ...(extraHeaders || {})
    }
  });
  if (res.status === 204) return null;
  if (!res.ok) throw new Error(await res.text());
  const t = await res.text();
  return t ? JSON.parse(t) : null;
}

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
const DAY_NAMES_JP = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
const MONTHS_EN = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// ‚îÄ‚îÄ Holidays ‚îÄ‚îÄ
const holidayCache = {};
function nthWeekday(year, month, weekday, n) {
  const first = new Date(year, month-1, 1);
  let d = ((weekday - first.getDay()) + 7) % 7 + 1;
  d += (n-1) * 7;
  return d;
}
function vernalEquinox(y) { return Math.floor(20.8431 + 0.242194*(y-1980) - Math.floor((y-1980)/4)); }
function autumnalEquinox(y) { return Math.floor(23.2488 + 0.242194*(y-1980) - Math.floor((y-1980)/4)); }
function getJapaneseHolidays(year) {
  const holidays = {};
  const addH = (m,d,name) => { holidays[`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`] = name; };
  addH(1,1,'ÂÖÉÊó•'); addH(1,nthWeekday(year,1,1,2),'Êàê‰∫∫„ÅÆÊó•');
  addH(2,11,'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•'); addH(2,23,'Â§©ÁöáË™ïÁîüÊó•');
  addH(3,vernalEquinox(year),'Êò•ÂàÜ„ÅÆÊó•');
  addH(4,29,'Êò≠Âíå„ÅÆÊó•');
  addH(5,3,'ÊÜ≤Ê≥ïË®òÂøµÊó•'); addH(5,4,'„Åø„Å©„Çä„ÅÆÊó•'); addH(5,5,'„Åì„Å©„ÇÇ„ÅÆÊó•');
  addH(7,nthWeekday(year,7,1,3),'Êµ∑„ÅÆÊó•'); addH(8,11,'Â±±„ÅÆÊó•');
  addH(9,nthWeekday(year,9,1,3),'Êï¨ËÄÅ„ÅÆÊó•'); addH(9,autumnalEquinox(year),'ÁßãÂàÜ„ÅÆÊó•');
  addH(10,nthWeekday(year,10,1,2),'„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•');
  addH(11,3,'ÊñáÂåñ„ÅÆÊó•'); addH(11,23,'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•');
  const baseKeys = Object.keys(holidays);
  for (const key of baseKeys) {
    const d = new Date(key); if (d.getDay() === 0) {
      const next = new Date(d); next.setDate(next.getDate()+1);
      const nk = dateKey(next);
      while(holidays[nk]){ next.setDate(next.getDate()+1); }
      holidays[dateKey(next)] = 'ÊåØÊõø‰ºëÊó•';
    }
  }
  for (const key of Object.keys(holidays)) {
    const d1 = new Date(key); const d2 = new Date(key); d2.setDate(d2.getDate()+2);
    if (holidays[dateKey(d2)]) {
      const mid = new Date(d1); mid.setDate(mid.getDate()+1);
      const mk = dateKey(mid);
      if (!holidays[mk] && mid.getDay()!==0 && mid.getDay()!==6) holidays[mk] = 'ÂõΩÊ∞ë„ÅÆ‰ºëÊó•';
    }
  }
  return holidays;
}
function getHoliday(d) {
  const y = d.getFullYear();
  if (!holidayCache[y]) holidayCache[y] = getJapaneseHolidays(y);
  return holidayCache[y][dateKey(d)] || null;
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let currentWeekStart = getMonday(new Date());
let weekTasks = {};   // { dateKey: [task, ...] }
let poolTasks = [];
let dragState = null;
let saving = false;

function getMonday(d) {
  const date = new Date(d); const day = date.getDay();
  date.setDate(date.getDate() - day + (day===0 ? -6 : 1)); date.setHours(0,0,0,0);
  return date;
}
function dateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function isToday(d) {
  const t = new Date();
  return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function setLoading(v) { document.getElementById('loadingBar').classList.toggle('visible', v); }

// ‚îÄ‚îÄ Load from Supabase ‚îÄ‚îÄ
async function loadWeek() {
  setLoading(true);
  try {
    const weekEnd = new Date(currentWeekStart); weekEnd.setDate(weekEnd.getDate()+6);
    const rows = await sbFetch(
      `week_tasks?select=*&date=gte.${dateKey(currentWeekStart)}&date=lte.${dateKey(weekEnd)}&order=sort_order.asc`
    );
    weekTasks = {};
    (rows || []).forEach(r => {
      if (!weekTasks[r.date]) weekTasks[r.date] = [];
      weekTasks[r.date].push({ id: r.id, text: r.text, done: r.done, fromPool: r.from_pool, top3: r.top3 });
    });
    const pool = await sbFetch('pool_tasks?select=*&order=sort_order.asc');
    poolTasks = (pool || []).map(r => ({ id: r.id, text: r.text }));
    render();
  } catch(e) {
    showToast('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + e.message);
  } finally {
    setLoading(false);
  }
}

// ‚îÄ‚îÄ Save helpers ‚îÄ‚îÄ
async function saveTask(task, dateK) {
  try {
    await sbFetch('week_tasks', {
      method: 'POST',
      headers: { 'Prefer': 'resolution=merge-duplicates,return=minimal' },
      body: JSON.stringify({ id: task.id, date: dateK, text: task.text, done: task.done, from_pool: task.fromPool||false, top3: task.top3||false, sort_order: 0 })
    });
  } catch(e) { showToast('‰øùÂ≠ò„Ç®„É©„Éº'); }
}
async function deleteTaskDB(id) {
  try { await sbFetch(`week_tasks?id=eq.${id}`, { method: 'DELETE' }); } catch(e) { showToast('ÂâäÈô§„Ç®„É©„Éº'); }
}
async function savePoolTask(task) {
  try {
    await sbFetch('pool_tasks', {
      method: 'POST',
      headers: { 'Prefer': 'resolution=merge-duplicates,return=minimal' },
      body: JSON.stringify({ id: task.id, text: task.text, sort_order: 0 })
    });
  } catch(e) { showToast('‰øùÂ≠ò„Ç®„É©„Éº'); }
}
async function deletePoolTaskDB(id) {
  try { await sbFetch(`pool_tasks?id=eq.${id}`, { method: 'DELETE' }); } catch(e) { showToast('ÂâäÈô§„Ç®„É©„Éº'); }
}

// ‚îÄ‚îÄ Week Task Actions ‚îÄ‚îÄ
async function toggleTask(key, idx) {
  if (!weekTasks[key]?.[idx]) return;
  weekTasks[key][idx].done = !weekTasks[key][idx].done;
  render();
  await saveTask(weekTasks[key][idx], key);
}
async function deleteTask(key, idx) {
  if (!weekTasks[key]) return;
  const task = weekTasks[key][idx];
  weekTasks[key].splice(idx, 1);
  if (!weekTasks[key].length) delete weekTasks[key];
  render();
  await deleteTaskDB(task.id);
}
async function addTask(key) {
  if (!weekTasks[key]) weekTasks[key] = [];
  const task = { id: uid(), text: '', done: false, fromPool: false, top3: false };
  weekTasks[key].push(task);
  render();
  setTimeout(() => { const el = document.querySelector(`[data-tid="${task.id}"] .task-text`); if(el) el.focus(); }, 50);
  await saveTask(task, key);
}
async function updateTaskText(key, idx, text) {
  if (!weekTasks[key]?.[idx]) return;
  weekTasks[key][idx].text = text;
  await saveTask(weekTasks[key][idx], key);
}
function taskKeydown(e, key, idx) {
  if (e.key==='Enter') { e.preventDefault(); addTask(key); }
  if (e.key==='Backspace' && weekTasks[key][idx].text==='') { e.preventDefault(); deleteTask(key, idx); }
}
async function toggleTop3(key, idx) {
  if (!weekTasks[key]?.[idx]) return;
  const task = weekTasks[key][idx];
  // ‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„Åøtop3Ë®≠ÂÆöÂèØËÉΩ
  const todayK = dateKey(new Date());
  if (key !== todayK) { showToast('‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÅÆ„Åø„Éà„ÉÉ„Éó3„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô'); return; }
  // top3„ÅØÊúÄÂ§ß3„Å§
  const currentTop3 = (weekTasks[key] || []).filter(t => t.top3 && t.id !== task.id).length;
  if (!task.top3 && currentTop3 >= 3) { showToast('„Éà„ÉÉ„Éó3„ÅØ„Åô„Åß„Å´3„Å§Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô'); return; }
  task.top3 = !task.top3;
  render();
  await saveTask(task, key);
  showToast(task.top3 ? '„Éà„ÉÉ„Éó3„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü ‚ú¶' : '„Éà„ÉÉ„Éó3„Åã„ÇâÂ§ñ„Åó„Åæ„Åó„Åü');
}

// ‚îÄ‚îÄ Pool Actions ‚îÄ‚îÄ
async function addPoolTask() {
  const task = { id: uid(), text: '' };
  poolTasks.push(task);
  render();
  setTimeout(() => { const el = document.querySelector(`[data-pid="${task.id}"] .pool-text`); if(el) el.focus(); }, 50);
  await savePoolTask(task);
}
async function updatePoolText(idx, text) {
  if (!poolTasks[idx]) return;
  poolTasks[idx].text = text;
  await savePoolTask(poolTasks[idx]);
}
async function deletePoolTask(idx) {
  const task = poolTasks[idx];
  poolTasks.splice(idx, 1);
  render();
  await deletePoolTaskDB(task.id);
}
function poolKeydown(e, idx) {
  if (e.key==='Enter') { e.preventDefault(); addPoolTask(); }
  if (e.key==='Backspace' && poolTasks[idx].text==='') { e.preventDefault(); deletePoolTask(idx); }
}

// ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ
function onTaskDragStart(e, key, idx) {
  dragState = { source:'week', key, idx, data:{...weekTasks[key][idx]} };
  e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain','');
  requestAnimationFrame(()=>{ e.target.closest('.task-item')?.classList.add('dragging'); });
}
function onPoolDragStart(e, idx) {
  dragState = { source:'pool', idx, data:{...poolTasks[idx]} };
  e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain','');
  requestAnimationFrame(()=>{ e.target.closest('.pool-item')?.classList.add('dragging'); });
}
function onDragEnd() {
  dragState = null;
  document.querySelectorAll('.dragging,.drag-over,.drop-above,.drop-below')
    .forEach(el=>el.classList.remove('dragging','drag-over','drop-above','drop-below'));
}
function onColDragOver(e) {
  e.preventDefault(); e.dataTransfer.dropEffect='move';
  const col = e.target.closest('.day-col');
  if (col) { document.querySelectorAll('.day-col.drag-over').forEach(el=>{ if(el!==col)el.classList.remove('drag-over'); }); col.classList.add('drag-over'); }
  document.querySelectorAll('.drop-above,.drop-below').forEach(el=>el.classList.remove('drop-above','drop-below'));
  const ti = e.target.closest('.task-item');
  if (ti) { const r = ti.getBoundingClientRect(); ti.classList.add(e.clientY<r.top+r.height/2?'drop-above':'drop-below'); }
}
function onColDragLeave(e) {
  const col = e.target.closest('.day-col');
  if (col && !col.contains(e.relatedTarget)) col.classList.remove('drag-over');
}
async function onColDrop(e, targetKey) {
  e.preventDefault();
  if (!dragState) return;
  const { source, key:srcKey, idx, data } = dragState;
  let dropIdx = (weekTasks[targetKey]||[]).length;
  const ti = e.target.closest('.task-item');
  if (ti) { const i = parseInt(ti.dataset.idx,10); const r = ti.getBoundingClientRect(); dropIdx = e.clientY<r.top+r.height/2?i:i+1; }

  const newTask = { id: uid(), text: data.text, done: data.done||false, fromPool: source==='pool', top3: false };

  if (source==='pool') {
    const poolTask = poolTasks[idx];
    poolTasks.splice(idx, 1);
    await deletePoolTaskDB(poolTask.id);
  } else if (source==='week') {
    const oldTask = weekTasks[srcKey][idx];
    weekTasks[srcKey].splice(idx, 1);
    if (!weekTasks[srcKey].length) delete weekTasks[srcKey];
    await deleteTaskDB(oldTask.id);
    if (srcKey===targetKey && idx<dropIdx) dropIdx--;
  }

  if (!weekTasks[targetKey]) weekTasks[targetKey] = [];
  weekTasks[targetKey].splice(dropIdx, 0, newTask);
  dragState = null;
  render();
  await saveTask(newTask, targetKey);
}
function onPoolColDragOver(e) {
  e.preventDefault(); e.dataTransfer.dropEffect='move';
  const col = e.target.closest('.pool-col'); if(col) col.classList.add('drag-over');
  document.querySelectorAll('.drop-above,.drop-below').forEach(el=>el.classList.remove('drop-above','drop-below'));
  const pi = e.target.closest('.pool-item');
  if (pi) { const r = pi.getBoundingClientRect(); pi.classList.add(e.clientY<r.top+r.height/2?'drop-above':'drop-below'); }
}
function onPoolColDragLeave(e) {
  const col = e.target.closest('.pool-col');
  if (col && !col.contains(e.relatedTarget)) col.classList.remove('drag-over');
}
async function onPoolColDrop(e) {
  e.preventDefault();
  document.querySelectorAll('.pool-col.drag-over').forEach(el=>el.classList.remove('drag-over'));
  if (!dragState) return;
  const { source, key:srcKey, idx, data } = dragState;
  let dropIdx = poolTasks.length;
  const pi = e.target.closest('.pool-item');
  if (pi) { const ti = parseInt(pi.dataset.pidx,10); const r = pi.getBoundingClientRect(); dropIdx = e.clientY<r.top+r.height/2?ti:ti+1; }

  const newTask = { id: uid(), text: data.text };
  if (source==='pool') {
    const old = poolTasks[idx];
    poolTasks.splice(idx, 1);
    await deletePoolTaskDB(old.id);
    if (idx<dropIdx) dropIdx--;
  } else if (source==='week') {
    const old = weekTasks[srcKey][idx];
    weekTasks[srcKey].splice(idx, 1);
    if (!weekTasks[srcKey].length) delete weekTasks[srcKey];
    await deleteTaskDB(old.id);
  }
  poolTasks.splice(dropIdx, 0, newTask);
  dragState = null;
  render();
  await savePoolTask(newTask);
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function renderDayCol(d, key) {
  const dayTasks = weekTasks[key] || [];
  const todayFlag = isToday(d);
  const isWeekend = d.getDay()===0 || d.getDay()===6;
  const holiday = getHoliday(d);
  const todayK = dateKey(new Date());
  const isCurrentDay = key === todayK;

  let cls = 'day-col';
  if (todayFlag) cls += ' is-today';
  if (isWeekend) cls += ' is-weekend';
  if (holiday) cls += ' is-holiday';

  let tasksHtml = '';
  dayTasks.forEach((task, idx) => {
    let taskCls = 'task-item';
    if (task.fromPool) taskCls += ' from-pool';
    if (task.top3) taskCls += ' is-top3';

    tasksHtml += `<div class="${taskCls}" draggable="true" data-tid="${task.id}" data-idx="${idx}"
      ondragstart="onTaskDragStart(event,'${key}',${idx})" ondragend="onDragEnd()">
      <div class="drag-handle"><svg viewBox="0 0 8 12" fill="currentColor"><circle cx="2" cy="1.5" r="1"/><circle cx="6" cy="1.5" r="1"/><circle cx="2" cy="6" r="1"/><circle cx="6" cy="6" r="1"/><circle cx="2" cy="10.5" r="1"/><circle cx="6" cy="10.5" r="1"/></svg></div>
      <div class="task-cb ${task.done?'checked':''}" onclick="toggleTask('${key}',${idx})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
      </div>
      <div class="task-text ${task.done?'done':''}" contenteditable="true"
        oninput="updateTaskText('${key}',${idx},this.textContent)"
        onkeydown="taskKeydown(event,'${key}',${idx})">${task.text}</div>
      ${isCurrentDay ? `<button class="task-top3-btn ${task.top3?'active':''}" onclick="toggleTop3('${key}',${idx})" title="${task.top3?'„Éà„ÉÉ„Éó3„Åã„ÇâÂ§ñ„Åô':'„Éà„ÉÉ„Éó3„Å´ËøΩÂä†'}">
        <svg viewBox="0 0 24 24" fill="${task.top3?'currentColor':'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      </button>` : ''}
      <button class="task-del" onclick="deleteTask('${key}',${idx})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>`;
  });

  return `<div class="${cls}" ondragover="onColDragOver(event)" ondragleave="onColDragLeave(event)" ondrop="onColDrop(event,'${key}')">
    <div class="day-header">
      <div class="day-name">${DAY_NAMES_JP[d.getDay()]}</div>
      <div class="day-number">${d.getDate()}</div>
      ${holiday ? `<div class="holiday-label">${holiday}</div>` : ''}
      ${todayFlag ? '<div class="day-dot"></div>' : ''}
    </div>
    <div class="task-list">${tasksHtml}</div>
    <button class="add-task-btn" onclick="addTask('${key}')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
      ËøΩÂä†
    </button>
  </div>`;
}

function renderPoolCol() {
  let itemsHtml = '';
  poolTasks.forEach((task, idx) => {
    itemsHtml += `<div class="pool-item" draggable="true" data-pid="${task.id}" data-pidx="${idx}"
      ondragstart="onPoolDragStart(event,${idx})" ondragend="onDragEnd()">
      <div class="pool-handle"><svg viewBox="0 0 8 12" fill="currentColor"><circle cx="2" cy="1.5" r="1"/><circle cx="6" cy="1.5" r="1"/><circle cx="2" cy="6" r="1"/><circle cx="6" cy="6" r="1"/><circle cx="2" cy="10.5" r="1"/><circle cx="6" cy="10.5" r="1"/></svg></div>
      <div class="pool-text" contenteditable="true"
        oninput="updatePoolText(${idx},this.textContent)"
        onkeydown="poolKeydown(event,${idx})">${task.text}</div>
      <button class="pool-del" onclick="deletePoolTask(${idx})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>`;
  });
  return `<div class="pool-col" ondragover="onPoolColDragOver(event)" ondragleave="onPoolColDragLeave(event)" ondrop="onPoolColDrop(event)">
    <div class="pool-header">
      <div class="pool-title"><span class="pool-title-icon">üóÇ</span> „Çø„Çπ„ÇØ„Éó„Éº„É´</div>
      <div class="pool-count">${poolTasks.length}</div>
    </div>
    <div class="pool-list">${itemsHtml}</div>
    <button class="pool-add-btn" onclick="addPoolTask()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
      ËøΩÂä†
    </button>
    <div class="pool-hint">ÊõúÊó•Ê¨Ñ„Å´„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÊåØ„ÇäÂàÜ„Åë‚ú¶<br>‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ„ÅØ‚òÖ„Åß„Éà„ÉÉ„Éó3„Å´Ë®≠ÂÆö</div>
  </div>`;
}

function render() {
  const weekEnd = new Date(currentWeekStart); weekEnd.setDate(weekEnd.getDate()+6);
  document.getElementById('weekLabel').textContent =
    `${MONTHS_EN[currentWeekStart.getMonth()]} ${currentWeekStart.getDate()} ‚Äì ${MONTHS_EN[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;

  const days = [];
  for (let i=0; i<7; i++) {
    const d = new Date(currentWeekStart); d.setDate(d.getDate()+i);
    days.push({ d, key: dateKey(d) });
  }
  document.getElementById('rowTop').innerHTML = days.slice(0,4).map(({d,key})=>renderDayCol(d,key)).join('');
  document.getElementById('rowBottom').innerHTML = days.slice(4,7).map(({d,key})=>renderDayCol(d,key)).join('') + renderPoolCol();

  let total=0, done=0;
  Object.values(weekTasks).forEach(arr=>{ total+=arr.length; done+=arr.filter(t=>t.done).length; });
  const pct = total>0 ? Math.round(done/total*100) : 0;
  document.getElementById('progressFill').style.width = pct+'%';
  document.getElementById('progressText').textContent = total>0 ? `${done}/${total} done ‚ú¶ ${pct}%` : '„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Å¶„Å≠ ‚ú¶';
}

function navigate(dir) {
  currentWeekStart = new Date(currentWeekStart);
  currentWeekStart.setDate(currentWeekStart.getDate() + dir*7);
  loadWeek();
}
function goToday() { currentWeekStart = getMonday(new Date()); loadWeek(); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadWeek();
</script>
</body>
</html>
