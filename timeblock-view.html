<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time Block View</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --sky-pale: #dff0f7;
    --sky: #a8d8ea;
    --sky-mid: #7ec8e3;
    --brown: #6b4f3a;
    --brown-light: #a0785a;
    --text: #3a2e28;
    --text-mid: #7a6560;
    --text-light: #b0a09a;
    --border: #d8e8f0;
    --white: #ffffff;
    --radius: 10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', 'Noto Sans JP', sans-serif;
    background: var(--sky-pale);
    color: var(--text);
    padding: 12px 16px;
    -webkit-font-smoothing: antialiased;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .date-label {
    font-size: 12px;
    color: var(--text-mid);
    font-weight: 500;
  }

  .current-time {
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--brown-light);
  }

  /* ブロック一覧 横並び */
  .blocks-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }

  .block-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    border: 1.5px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .block-chip.current {
    transform: scale(1.08);
    box-shadow: 0 2px 12px rgba(0,0,0,0.12);
  }

  .block-chip.past {
    opacity: 0.35;
  }

  .block-chip.future {
    opacity: 0.65;
  }

  .block-hour {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    opacity: 0.7;
  }

  /* 現在インジケーター */
  .current-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #e05a5a;
    animation: pulse 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(224,90,90,0.4); }
    50% { box-shadow: 0 0 0 4px rgba(224,90,90,0); }
  }

  /* 空状態 */
  .empty {
    font-size: 12px;
    color: var(--text-light);
    padding: 8px 0;
  }

  /* ローディング */
  .loading {
    font-size: 11px;
    color: var(--text-light);
    padding: 8px 0;
  }
</style>
</head>
<body>

<div class="header">
  <div class="date-label" id="dateLabel"></div>
  <div class="current-time" id="currentTime"></div>
</div>

<div class="blocks-row" id="blocksRow">
  <div class="loading">読み込み中...</div>
</div>

<script>
const SUPABASE_URL = 'https://nbduyknklcwqbinvhoih.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iZHV5a25rbGN3cWJpbnZob2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjMzNjUsImV4cCI6MjA4NzIzOTM2NX0.kzZYqBwfc8vpGszN2W3so2jURsZXlrve4KvUydYKIfA'; // ← 新しいキーを貼る

const DAYS_JP = ['日','月','火','水','木','金','土'];

async function sbFetch(path) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`
    }
  });
  if (!res.ok) throw new Error(await res.text());
  const t = await res.text();
  return t ? JSON.parse(t) : null;
}

function dateKey() {
  const d = new Date();
  const offset = d.getTimezoneOffset();
  const local = new Date(d.getTime() - offset * 60000);
  return local.toISOString().slice(0, 10);
}

function getTextColor(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return (r*0.299 + g*0.587 + b*0.114) > 150 ? '#3a2e28' : '#ffffff';
}

function updateHeader() {
  const d = new Date();
  const dow = DAYS_JP[d.getDay()];
  document.getElementById('dateLabel').textContent =
    `${d.getMonth()+1}月${d.getDate()}日（${dow}）`;
  document.getElementById('currentTime').textContent =
    `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

async function render() {
  updateHeader();
  const now = new Date();
  const nowHour = now.getHours();

  let blocks = [];
  try {
    const rows = await sbFetch(`timeblocks?date=eq.${dateKey()}&select=*`);
    if (rows && rows.length > 0) {
      blocks = JSON.parse(rows[0].blocks_json || '[]');
    }
  } catch(e) {
    console.error(e);
  }

  const row = document.getElementById('blocksRow');

  if (blocks.length === 0) {
    row.innerHTML = '<div class="empty">今日のブロックはまだ設定されていません</div>';
    return;
  }

  row.innerHTML = blocks.map(b => {
    const isCurrent = b.hour === nowHour;
    const isPast = b.hour < nowHour;
    const textColor = getTextColor(b.color);
    const bgColor = b.color + (isCurrent ? '55' : '28');
    const borderColor = b.color + (isCurrent ? 'aa' : '55');

    let cls = 'block-chip';
    if (isCurrent) cls += ' current';
    else if (isPast) cls += ' past';
    else cls += ' future';

    return `<div class="${cls}" style="background:${bgColor};border-color:${borderColor};color:${textColor};">
      ${isCurrent ? '<div class="current-dot"></div>' : ''}
      <span>${b.label}</span>
      <span class="block-hour">${String(b.hour).padStart(2,'0')}:00</span>
    </div>`;
  }).join('');
}

render();
setInterval(() => {
  updateHeader();
  render();
}, 60000);
</script>
</body>
</html>
