<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time Block View</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600&family=Playfair+Display:wght@400;600;700&family=Raleway:wght@300;400;600&family=Quicksand:wght@400;600;700&family=Josefin+Sans:wght@300;400;600&display=swap" rel="stylesheet"><style>
  :root {
    --sky-pale: #eef7fc;
    --sky: #a8d8ea;
    --sky-mid: #7ec8e3;
    --sky-light: #d6eef8;
    --brown: #8b6f5e;
    --brown-light: #c4a882;
    --brown-pale: #f5ede6;
    --text: #4a3728;
    --text-mid: #9e7c6a;
    --text-light: #c4a882;
    --border: rgba(139,111,94,0.15);
    --white: #ffffff;
    --radius: 14px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', 'Noto Sans JP', sans-serif;
    background: var(--sky-pale);
    color: var(--text);
    padding: 16px 20px 20px;
    -webkit-font-smoothing: antialiased;
  }

  /* ── ヘッダー ── */
  .header {
    display: flex;
    align-items: flex-end;
    gap: 20px;
    margin-bottom: 18px;
  }

  .date-block { display: flex; flex-direction: column; gap: 3px; }

  .date-main {
    font-size: 24px;
    font-family: 'Josefin Sans', sans-serif;
    font-weight: 600;
    color: var(--brown);
    line-height: 1;
    letter-spacing: 0.02em;
  }

  .date-sub {
    font-size: 11px;
    color: var(--text-mid);
  }

  .divider {
    width: 1.5px;
    height: 36px;
    background: var(--border);
    border-radius: 1px;
    margin-bottom: 2px;
  }

  .time-block { display: flex; flex-direction: column; gap: 2px; }

  .time-main {
    font-size: 38px;
    font-family: 'Josefin Sans', sans-serif;
    font-weight: 600;
    color: var(--brown);
    line-height: 1;
    letter-spacing: 0.02em;
  }

  .time-label {
    font-size: 9px;
    color: var(--text-light);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .current-block-area {
    margin-left: auto;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 3px;
    padding-bottom: 4px;
  }

  .current-block-name {
    font-size: 15px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 7px;
  }

  .current-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #e05a5a;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { box-shadow: 0 0 0 0 rgba(224,90,90,0.5); }
    50%      { box-shadow: 0 0 0 5px rgba(224,90,90,0); }
  }

  .current-block-time {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    color: var(--text-light);
  }


  .timeline-wrap {
    background: var(--white);
    border-radius: var(--radius);
    border: 1.5px solid var(--border);
    overflow: hidden;
  }

  .hour-labels {
    position: relative;
    height: 18px;
    background: color-mix(in srgb, var(--sky-pale) 60%, white);
    border-bottom: 1px solid var(--border);
  }

  .hour-label-item {
    position: absolute;
    font-size: 9px;
    font-family: 'DM Mono', monospace;
    color: var(--text-light);
    transform: translateX(-50%);
    top: 4px;
    white-space: nowrap;
  }

  .timeline-body {
    position: relative;
    height: 52px;
  }

  .grid-line {
    position: absolute;
    top: 0; bottom: 0;
    width: 1px;
    background: var(--border);
    opacity: 0.6;
  }

  .tl-block {
    position: absolute;
    top: 7px; bottom: 7px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    border: 1.5px solid transparent;
    overflow: hidden;
    padding: 0 5px;
    white-space: nowrap;
    transition: all 0.3s ease;
  }

  .tl-block.past    { opacity: 0.3; }
  .tl-block.future  { opacity: 0.65; }
  .tl-block.current {
    top: 3px; bottom: 3px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.13);
    z-index: 2;
  }

  .tl-block-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .now-line {
    position: absolute;
    top: 0; bottom: 0;
    width: 2px;
    background: #e05a5a;
    z-index: 10;
    border-radius: 1px;
  }
  .now-line::before {
    content: '';
    position: absolute;
    top: -3px; left: -3px;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #e05a5a;
  }

  .empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 52px;
    font-size: 12px;
    color: var(--text-light);
  }
</style>
</head>
<body>

<div class="header">
  <div class="date-block">
    <div class="date-main" id="dateMain"></div>
    <div class="date-sub" id="dateSub"></div>
  </div>
  <div class="divider"></div>
  <div class="time-block">
    <div class="time-main" id="timeMain"></div>
    <div class="time-label">NOW</div>
  </div>
  <div class="current-block-area" id="currentBlockArea"></div>
</div>

<div class="timeline-wrap">
  <div class="hour-labels" id="hourLabels"></div>
  <div class="timeline-body" id="timelineBody">
    <div class="empty">読み込み中...</div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://nbduyknklcwqbinvhoih.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iZHV5a25rbGN3cWJpbnZob2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjMzNjUsImV4cCI6MjA4NzIzOTM2NX0.kzZYqBwfc8vpGszN2W3so2jURsZXlrve4KvUydYKIfA';

const DAYS_JP = ['日','月','火','水','木','金','土'];
const TL_START = 6;
const TL_END   = 24;
const TL_HOURS = TL_END - TL_START;

async function sbFetch(path) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`
    }
  });
  if (!res.ok) throw new Error(await res.text());
  const t = await res.text();
  return t ? JSON.parse(t) : null;
}

function dateKey() {
  const d = new Date();
  const offset = d.getTimezoneOffset();
  const local = new Date(d.getTime() - offset * 60000);
  return local.toISOString().slice(0, 10);
}

function getTextColor(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return (r*0.299 + g*0.587 + b*0.114) > 150 ? '#3a2e28' : '#ffffff';
}

function hourToPercent(h) {
  return ((h - TL_START) / TL_HOURS) * 100;
}

function updateHeader(blocks) {
  const d = new Date();
  const dow = DAYS_JP[d.getDay()];
  document.getElementById('dateMain').textContent = `${d.getMonth()+1}月${d.getDate()}日`;
  document.getElementById('dateSub').textContent  = `${d.getFullYear()}年 （${dow}）`;
  document.getElementById('timeMain').textContent =
    `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

  const nowHour = d.getHours();
  const cur = blocks.find(b => b.hour === nowHour);
  const area = document.getElementById('currentBlockArea');
  if (cur) {
    area.innerHTML = `
      <div class="current-block-name">
        <div class="current-dot"></div>
        <span style="color:${cur.color}">${cur.label}</span>
      </div>
      <div class="current-block-time">${String(nowHour).padStart(2,'0')}:00 〜 ${String(nowHour+1).padStart(2,'0')}:00</div>`;
  } else {
    area.innerHTML = `<div class="current-block-time" style="color:var(--text-light)">予定なし</div>`;
  }
}

function renderTimeline(blocks) {
  const d = new Date();
  const nowHour = d.getHours();
  const nowMin  = d.getHours() * 60 + d.getMinutes();
  const nowPct  = ((nowMin / 60 - TL_START) / TL_HOURS) * 100;

  // 時間ラベル（偶数時間のみ）
  let labelsHtml = '';
  for (let h = TL_START; h <= TL_END; h += 2) {
    labelsHtml += `<div class="hour-label-item" style="left:${hourToPercent(h)}%">${String(h).padStart(2,'0')}</div>`;
  }
  document.getElementById('hourLabels').innerHTML = labelsHtml;

  const body = document.getElementById('timelineBody');
  if (blocks.length === 0) {
    body.innerHTML = '<div class="empty">今日のブロックはまだ設定されていません</div>';
    return;
  }

  let html = '';

  // グリッド線（1時間ごと）
  for (let h = TL_START; h <= TL_END; h++) {
    html += `<div class="grid-line" style="left:${hourToPercent(h)}%"></div>`;
  }

  // ブロック
  blocks.forEach(b => {
    if (b.hour < TL_START || b.hour >= TL_END) return;
    const left  = hourToPercent(b.hour);
    const width = (1 / TL_HOURS) * 100;
    const isCurrent = b.hour === nowHour;
    const isPast    = b.hour < nowHour;
    const textColor   = getTextColor(b.color);
    const bgColor     = b.color + (isCurrent ? '66' : '33');
    const borderColor = b.color + (isCurrent ? 'cc' : '66');
    let cls = 'tl-block' + (isCurrent ? ' current' : isPast ? ' past' : ' future');

    html += `<div class="${cls}"
      style="left:${left}%;width:calc(${width}% - 2px);background:${bgColor};border-color:${borderColor};color:${textColor};">
      <span class="tl-block-text">${b.label}</span>
    </div>`;
  });

  // 現在時刻ライン
  if (nowPct >= 0 && nowPct <= 100) {
    html += `<div class="now-line" style="left:${nowPct}%"></div>`;
  }

  body.innerHTML = html;
}

let cachedBlocks = [];

async function render() {
  try {
    const rows = await sbFetch(`timeblocks?date=eq.${dateKey()}&select=*`);
    cachedBlocks = (rows && rows.length > 0) ? JSON.parse(rows[0].blocks_json || '[]') : [];
  } catch(e) { console.error(e); }
  updateHeader(cachedBlocks);
  renderTimeline(cachedBlocks);
}

function tick() {
  updateHeader(cachedBlocks);
  renderTimeline(cachedBlocks);
}

render();
setInterval(tick, 60000);
setInterval(render, 300000);
</script>
</body>
</html>
