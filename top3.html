<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Today's Top 3</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --sky: #a8d8ea; --sky-light: #d6eef8; --sky-pale: #eef7fc;
    --brown: #8b6f5e; --brown-light: #c4a882; --brown-pale: #f5ede6;
    --blush: #f2c4b8; --mint: #b8dfd0; --yellow: #fce8a2;
    --text: #4a3728; --text-muted: #9e7c6a; --text-light: #c4a882;
    --white: #ffffff; --border: rgba(139,111,94,0.15); --shadow: rgba(139,111,94,0.10);
    --radius: 14px; --top3: #c47ec0;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Zen Maru Gothic', sans-serif; background: var(--sky-pale); padding: 16px 16px 24px; color: var(--text); -webkit-font-smoothing: antialiased; }
  .widget { max-width: 480px; margin: 0 auto; }

  /* Header */
  .header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 14px; padding: 0 2px; }
  .header-title { font-family: 'DM Serif Display', serif; font-size: 18px; color: var(--brown); }
  .header-date { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
  .header-count { font-size: 11px; color: var(--top3); font-weight: 700; }

  /* Loading */
  .loading-bar { height: 3px; background: var(--sky-light); border-radius: 99px; margin-bottom: 12px; overflow: hidden; opacity: 0; transition: opacity 0.2s; }
  .loading-bar.visible { opacity: 1; }
  .loading-bar-fill { height: 100%; background: linear-gradient(90deg, var(--top3), var(--sky)); border-radius: 99px; animation: loadingAnim 1.2s ease-in-out infinite; }
  @keyframes loadingAnim { 0%{width:0%;margin-left:0} 50%{width:70%;margin-left:15%} 100%{width:0%;margin-left:100%} }

  /* Card */
  .top3-card { background: var(--white); border: 1.5px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: 0 2px 12px var(--shadow); }

  /* Task items */
  .task-list { display: flex; flex-direction: column; gap: 8px; }
  .task-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 14px; border-radius: 12px;
    border: 1.5px solid var(--border); background: var(--white);
    transition: all 0.2s; animation: taskIn 0.3s ease both;
  }
  @keyframes taskIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
  .task-item:hover { border-color: var(--top3); box-shadow: 0 2px 8px rgba(196,126,192,0.1); }
  .task-item.done { background: var(--sky-pale); border-color: var(--sky-light); }
  .task-item.done .task-text { text-decoration: line-through; color: var(--text-light); }

  .task-num {
    font-family: 'DM Serif Display', serif; font-size: 22px;
    color: var(--top3); line-height: 1; min-width: 20px; text-align: center;
    opacity: 0.4; transition: opacity 0.2s;
  }
  .task-item:hover .task-num { opacity: 0.8; }
  .task-item.done .task-num { opacity: 0.2; }

  .task-cb {
    width: 20px; height: 20px; min-width: 20px; border-radius: 6px;
    border: 2px solid var(--border); background: var(--white);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .task-cb:hover { border-color: var(--top3); background: rgba(196,126,192,0.08); }
  .task-cb.checked { background: var(--top3); border-color: var(--top3); }
  .task-cb.checked svg { opacity: 1; }
  .task-cb svg { width: 11px; height: 11px; opacity: 0; color: white; transition: opacity 0.15s; }

  .task-text { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; line-height: 1.4; }

  /* Empty state */
  .empty-state { text-align: center; padding: 28px 16px; color: var(--text-muted); }
  .empty-icon { font-size: 28px; margin-bottom: 8px; }
  .empty-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; color: var(--text-muted); }
  .empty-sub { font-size: 11px; color: var(--text-light); line-height: 1.6; }

  /* All done */
  .all-done { text-align: center; padding: 20px 16px; }
  .all-done-icon { font-size: 32px; margin-bottom: 8px; animation: bounce 0.6s ease; }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  .all-done-text { font-size: 13px; font-weight: 700; color: var(--mint); }

  /* Progress */
  .progress-wrap { margin-top: 14px; }
  .progress-bg { height: 5px; background: rgba(196,126,192,0.15); border-radius: 99px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--top3), var(--sky)); border-radius: 99px; transition: width 0.5s cubic-bezier(0.34,1.56,0.64,1); }
  .progress-text { font-size: 10px; color: var(--text-muted); margin-top: 5px; text-align: right; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--sky-pale); border-radius: 99px; }
  ::-webkit-scrollbar-thumb { background: var(--sky); border-radius: 99px; }
  * { scrollbar-width: thin; scrollbar-color: var(--sky) var(--sky-pale); }

  /* Toast */
  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--brown); color: white; font-size: 12px; font-weight: 500; padding: 8px 18px; border-radius: 99px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); opacity: 0; transition: all 0.3s ease; pointer-events: none; z-index: 9999; font-family: 'Zen Maru Gothic', sans-serif; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div class="widget">
  <div class="header">
    <div>
      <div class="header-title">Today's Top 3 âœ¦</div>
      <div class="header-date" id="headerDate">â€”</div>
    </div>
    <div class="header-count" id="headerCount"></div>
  </div>

  <div class="loading-bar" id="loadingBar"><div class="loading-bar-fill"></div></div>

  <div class="top3-card">
    <div class="task-list" id="taskList"></div>
    <div class="progress-wrap" id="progressWrap" style="display:none">
      <div class="progress-bg"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      <div class="progress-text" id="progressText"></div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://nbduyknklcwqbinvhoih.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iZHV5a25rbGN3cWJpbnZob2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjMzNjUsImV4cCI6MjA4NzIzOTM2NX0.kzZYqBwfc8vpGszN2W3so2jURsZXlrve4KvUydYKIfA';

async function sbFetch(path, options = {}) {
  const { headers: extraHeaders, ...rest } = options;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    ...rest,
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      ...(extraHeaders || {})
    }
  });
  if (res.status === 204) return null;
  if (!res.ok) throw new Error(await res.text());
  const t = await res.text();
  return t ? JSON.parse(t) : null;
}

function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function setLoading(v) { document.getElementById('loadingBar').classList.toggle('visible', v); }

let tasks = [];

async function loadTop3() {
  setLoading(true);
  try {
    const rows = await sbFetch(`week_tasks?select=*&date=eq.${todayStr()}&top3=eq.true&order=sort_order.asc`);
    tasks = rows || [];
    render();
  } catch(e) {
    showToast('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
  } finally {
    setLoading(false);
  }
}

async function toggleDone(id) {
  const task = tasks.find(t => t.id === id);
  if (!task) return;
  task.done = !task.done;
  render();
  try {
    await sbFetch(`week_tasks?id=eq.${id}`, {
      method: 'PATCH',
      body: JSON.stringify({ done: task.done })
    });
    if (tasks.every(t => t.done) && tasks.length > 0) {
      setTimeout(() => showToast('ä»Šæ—¥ã®ãƒˆãƒƒãƒ—3ã€å…¨éƒ¨å®Œäº†ï¼ğŸ‰'), 300);
    }
  } catch(e) {
    task.done = !task.done;
    render();
    showToast('æ›´æ–°ã‚¨ãƒ©ãƒ¼');
  }
}

function render() {
  const d = new Date();
  const dow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
  document.getElementById('headerDate').textContent =
    `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆ${dow}ï¼‰`;

  const list = document.getElementById('taskList');
  const progressWrap = document.getElementById('progressWrap');

  if (tasks.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-icon">â­</div>
      <div class="empty-title">ä»Šæ—¥ã®ãƒˆãƒƒãƒ—3ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
      <div class="empty-sub">ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§<br>ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã«â˜…ã‚’ä»˜ã‘ã¦ãã ã•ã„</div>
    </div>`;
    document.getElementById('headerCount').textContent = '';
    progressWrap.style.display = 'none';
    return;
  }

  const done = tasks.filter(t => t.done).length;
  const pct = Math.round(done / tasks.length * 100);
  document.getElementById('headerCount').textContent = `${done}/${tasks.length}`;

  if (done === tasks.length) {
    list.innerHTML = `<div class="all-done">
      <div class="all-done-icon">ğŸ‰</div>
      <div class="all-done-text">ä»Šæ—¥ã®ãƒˆãƒƒãƒ—3ã€å…¨éƒ¨å®Œäº†ï¼</div>
    </div>`;
  } else {
    list.innerHTML = tasks.map((task, i) => `
      <div class="task-item ${task.done?'done':''}" style="animation-delay:${i*0.08}s">
        <div class="task-num">${i+1}</div>
        <div class="task-cb ${task.done?'checked':''}" onclick="toggleDone('${task.id}')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
        </div>
        <div class="task-text">${task.text || '(æœªå…¥åŠ›)'}</div>
      </div>
    `).join('');
  }

  progressWrap.style.display = 'block';
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${done}/${tasks.length} å®Œäº† âœ¦ ${pct}%`;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3000);
}

// 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
loadTop3();
setInterval(loadTop3, 60000);
</script>
</body>
</html>
